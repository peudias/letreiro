<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Letreiro LED – Scroller</title>
  <style>
    :root{
      --bg:#000000;
      --fg:#ff2b2b;     /* cor do texto */
      --glow:#ff5a5a;   /* brilho do LED */
      --speed:12s;      /* duração da animação para 1 ciclo */
      --size:12vw;      /* tamanho da fonte base */
      --gap:6vw;        /* espaço entre repetições */
      --weight:800;     /* peso da fonte */
    }

    html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, sans-serif; overscroll-behavior: none; }
    .wrap{ display:flex; flex-direction:column; height:100dvh; gap:.6rem; }

    .marquee{ position:relative; flex:1 1 auto; overflow:hidden; background:var(--bg); isolation:isolate; }
    .track{ position:absolute; inset:0; display:flex; align-items:center; gap:var(--gap); width:max-content; animation: scroll var(--speed) linear infinite; will-change: transform; }
    .track.paused{ animation-play-state: paused; }
    .chunk{ display:flex; align-items:center; gap:var(--gap); }
    .msg{ white-space:nowrap; font-size:var(--size); font-weight:var(--weight); letter-spacing:.06em; line-height:1; color:var(--fg); text-transform: none; text-rendering: optimizeLegibility; -webkit-font-smoothing: antialiased; filter: saturate(1.1); }
    .msg.upper{ text-transform: uppercase; }
    .led{ text-shadow: 0 0 .25em var(--glow), 0 0 .6em var(--glow), 0 0 1.2em var(--glow), 0 0 2em color-mix(in srgb, var(--glow) 60%, transparent); }

    @keyframes scroll{ from{ transform: translateX(0); } to{ transform: translateX(-50%); } }
    .rtl{ animation-direction: reverse; }

    .controls{ flex:0 0 auto; display:grid; grid-template-columns: repeat(12, 1fr); gap:.6rem; padding: .6rem .8rem .9rem; background: color-mix(in srgb, var(--bg) 86%, #111 14%); border-top:1px solid color-mix(in srgb, var(--fg) 20%, transparent); }
    .controls input[type="text"]{ grid-column: 1 / -1; }
    .controls label{ font-size:.9rem; color:#ddd; opacity:.9; }
    .controls input, .controls select, .controls button{ width:100%; }
    .controls .row{ display:flex; gap:.6rem; align-items:center; flex-wrap:wrap; }
    .controls .col-span-3{ grid-column: span 3; }
    .controls .col-span-4{ grid-column: span 4; }
    .controls .col-span-5{ grid-column: span 5; }
    .controls .col-span-6{ grid-column: span 6; }
    .controls .col-span-12{ grid-column: 1 / -1; }

    .btn{ background:#1f1f1f; color:#f0f0f0; border:1px solid #333; padding:.7rem .8rem; border-radius:.8rem; font-weight:600; cursor:pointer; }
    .btn:active{ transform: scale(.99); }
    .toggle{ display:flex; gap:.6rem; align-items:center; }
    .muted{ opacity:.75; }
    .footer{ text-align:center; font-size:.84rem; color:#bbb; padding:.4rem 0 .6rem; }

    @media (max-width: 520px){
      :root{ --size:14vw; --gap:10vw; }
      .controls{ grid-template-columns: repeat(6, 1fr); }
      .controls .col-span-6{ grid-column: 1 / -1; }
      .controls .col-span-4{ grid-column: span 3; }
      .controls .col-span-5{ grid-column: span 6; }
      .controls .col-span-3{ grid-column: span 3; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="marquee" id="marquee" aria-label="Faixa do letreiro">
      <div class="track led" id="track">
        <div class="chunk"><span class="msg upper" id="text1">myllla paolucci lousada cardoso...</span></div>
        <div class="chunk"><span class="msg upper" id="text2">myllla paolucci lousada cardoso...</span></div>
      </div>
    </div>

    <form class="controls" id="panel" autocomplete="off">
      <input class="col-span-12" type="text" id="inputText" placeholder="Digite sua mensagem…" value="myllla paolucci lousada cardoso..." />

      <div class="col-span-3">
        <label for="fg">Cor do texto</label>
        <input type="color" id="fg" value="#ff2b2b" />
      </div>
      <div class="col-span-3">
        <label for="glowColor">Cor do brilho</label>
        <input type="color" id="glowColor" value="#ff5a5a" />
      </div>
      <div class="col-span-3">
        <label for="bg">Cor do fundo</label>
        <input type="color" id="bg" value="#000000" />
      </div>
      <div class="col-span-3">
        <label for="size">Tamanho</label>
        <input type="range" id="size" min="6" max="26" step="1" value="12" />
      </div>

      <div class="col-span-3">
        <label for="speed">Velocidade</label>
        <input type="range" id="speed" min="4" max="40" step="1" value="12" />
      </div>
      <div class="col-span-3">
        <label for="gap">Espaçamento</label>
        <input type="range" id="gap" min="2" max="30" step="1" value="6" />
      </div>
      <div class="col-span-3">
        <label for="weight">Peso</label>
        <input type="range" id="weight" min="300" max="900" step="100" value="800" />
      </div>
      <div class="col-span-3">
        <label for="direction">Direção</label>
        <select id="direction">
          <option value="ltr">← (esquerda)</option>
          <option value="rtl">→ (direita)</option>
        </select>
      </div>

      <div class="col-span-6 row">
        <label class="toggle"><input type="checkbox" id="uppercase" checked /> MAIÚSCULAS</label>
        <label class="toggle"><input type="checkbox" id="glow" checked /> Brilho LED</label>
        <label class="toggle"><input type="checkbox" id="pause" /> Pausar</label>
      </div>

      <div class="col-span-6 row">
        <button type="button" class="btn" id="fullscreen">Tela cheia</button>
        <button type="button" class="btn" id="hide">Ocultar controles</button>
      </div>

      <div class="col-span-6 row">
        <label for="videoRes">Resolução/Orientação</label>
        <select id="videoRes">
          <option value="1920x1080">Horizontal (1920×1080)</option>
          <option value="1080x1920">Vertical (1080×1920)</option>
        </select>
        <label for="videoFps">FPS</label>
        <select id="videoFps">
          <option value="60">60</option>
          <option value="30">30</option>
        </select>
      </div>

      <div class="col-span-6 row">
        <label for="recSeconds">Duração do vídeo (s)</label>
        <input type="number" id="recSeconds" min="1" max="600" value="10" />
        <button type="button" class="btn" id="renderAutoWebm">Baixar WEBM (auto)</button>
        <button type="button" class="btn" id="renderAutoMp4">Baixar MP4 (auto)</button>
      </div>
    </form>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const track = $('#track');
    const t1 = $('#text1');
    const t2 = $('#text2');
    const panel = $('#panel');

    const state = {
      message: localStorage.getItem('led:message') || 'myllla paolucci lousada cardoso...',
      fg: localStorage.getItem('led:fg') || '#ff2b2b',
      glowColor: localStorage.getItem('led:glowColor') || '#ff5a5a',
      bg: localStorage.getItem('led:bg') || '#000000',
      speed: +(localStorage.getItem('led:speed') || 12),
      size: +(localStorage.getItem('led:size') || 12),
      gap: +(localStorage.getItem('led:gap') || 6),
      uppercase: JSON.parse(localStorage.getItem('led:uppercase') ?? 'true'),
      glow: JSON.parse(localStorage.getItem('led:glow') ?? 'true'),
      weight: +(localStorage.getItem('led:weight') || 800),
      dir: localStorage.getItem('led:dir') || 'ltr',
      paused: JSON.parse(localStorage.getItem('led:paused') ?? 'false'),
      res: localStorage.getItem('led:res') || '1920x1080',
      fps: +(localStorage.getItem('led:fps') || 60),
    };

    const inputText = $('#inputText');
    const fg = $('#fg');
    const glowColor = $('#glowColor');
    const bg = $('#bg');
    const speed = $('#speed');
    const size = $('#size');
    const gap = $('#gap');
    const weight = $('#weight');
    const uppercase = $('#uppercase');
    const glow = $('#glow');
    const pause = $('#pause');
    const dirSel = $('#direction');
    const fsBtn = $('#fullscreen');
    const hideBtn = $('#hide');
    const renderWebmBtn = $('#renderAutoWebm');
    const renderMp4Btn = $('#renderAutoMp4');
    const recSeconds  = $('#recSeconds');
    const videoResSel = $('#videoRes');
    const videoFpsSel = $('#videoFps');

    function setVar(name, value){ document.documentElement.style.setProperty(name, value); }

    function apply(){
      setVar('--fg', state.fg);
      setVar('--glow', state.glowColor);
      setVar('--bg', state.bg);
      setVar('--speed', state.speed + 's');
      setVar('--size', state.size + 'vw');
      setVar('--gap', state.gap + 'vw');
      setVar('--weight', state.weight);

      t1.textContent = state.message || '\u00A0';
      t2.textContent = state.message || '\u00A0';

      t1.classList.toggle('upper', !!state.uppercase);
      t2.classList.toggle('upper', !!state.uppercase);

      track.classList.toggle('led', !!state.glow);
      track.classList.toggle('rtl', state.dir === 'rtl');
      track.classList.toggle('paused', !!state.paused);

      localStorage.setItem('led:message', state.message);
      localStorage.setItem('led:fg', state.fg);
      localStorage.setItem('led:glowColor', state.glowColor);
      localStorage.setItem('led:bg', state.bg);
      localStorage.setItem('led:speed', String(state.speed));
      localStorage.setItem('led:size', String(state.size));
      localStorage.setItem('led:gap', String(state.gap));
      localStorage.setItem('led:uppercase', JSON.stringify(!!state.uppercase));
      localStorage.setItem('led:glow', JSON.stringify(!!state.glow));
      localStorage.setItem('led:weight', String(state.weight));
      localStorage.setItem('led:dir', state.dir);
      localStorage.setItem('led:paused', JSON.stringify(!!state.paused));
      localStorage.setItem('led:res', state.res);
      localStorage.setItem('led:fps', String(state.fps));
    }

    inputText.value = state.message;
    fg.value = state.fg;
    glowColor.value = state.glowColor;
    bg.value = state.bg;
    speed.value = state.speed;
    size.value = state.size;
    gap.value = state.gap;
    weight.value = state.weight;
    uppercase.checked = !!state.uppercase;
    glow.checked = !!state.glow;
    pause.checked = !!state.paused;
    dirSel.value = state.dir;
    videoResSel.value = state.res;
    videoFpsSel.value = String(state.fps);
    apply();

    inputText.addEventListener('input', (e)=>{ state.message = e.target.value; apply(); });
    fg.addEventListener('input', (e)=>{ state.fg = e.target.value; apply(); });
    glowColor.addEventListener('input', (e)=>{ state.glowColor = e.target.value; apply(); });
    bg.addEventListener('input', (e)=>{ state.bg = e.target.value; apply(); });
    speed.addEventListener('input', (e)=>{ state.speed = +e.target.value; apply(); });
    size.addEventListener('input', (e)=>{ state.size = +e.target.value; apply(); });
    gap.addEventListener('input', (e)=>{ state.gap = +e.target.value; apply(); });
    weight.addEventListener('input', (e)=>{ state.weight = +e.target.value; apply(); });
    uppercase.addEventListener('change', (e)=>{ state.uppercase = e.target.checked; apply(); });
    glow.addEventListener('change', (e)=>{ state.glow = e.target.checked; apply(); });
    pause.addEventListener('change', (e)=>{ state.paused = e.target.checked; apply(); });
    dirSel.addEventListener('change', (e)=>{ state.dir = e.target.value; apply(); });
    videoResSel.addEventListener('change', (e)=>{ state.res = e.target.value; apply(); });
    videoFpsSel.addEventListener('change', (e)=>{ state.fps = +e.target.value; apply(); });

    fsBtn.addEventListener('click', async ()=>{
      try{
        const el = document.documentElement;
        if(!document.fullscreenElement){ await el.requestFullscreen(); }
        else{ await document.exitFullscreen(); }
      }catch(err){ alert('Tela cheia não suportada neste navegador.'); }
    });

    hideBtn.addEventListener('click', ()=>{ panel.style.display = (panel.style.display === 'none' ? 'grid' : 'none'); });

    function pickMime(){
      const c = ['video/webm;codecs=vp9','video/webm;codecs=vp8','video/webm'];
      for(const t of c){ if(window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) return t; }
      return '';
    }

    async function renderAutoBlob(){
      const sec = Math.max(1, Math.min(600, parseInt(recSeconds.value||'10',10)));
      const [W,H] = state.res === '1080x1920' ? [1080,1920] : [1920,1080];
      const FPS = state.fps === 30 ? 30 : 60;

      const canvas = document.createElement('canvas');
      canvas.width = W; canvas.height = H;
      const ctx = canvas.getContext('2d');

      const stream = canvas.captureStream(FPS);
      const mime = pickMime();
      if(!mime){ throw new Error('Seu navegador não suporta gravação WebM/VP8/VP9. Use Chrome/Edge/Firefox.'); }

      const chunks = [];
      const recorder = new MediaRecorder(stream, { mimeType: mime, videoBitsPerSecond: 8_000_000 });
      recorder.ondataavailable = e=>{ if(e.data && e.data.size) chunks.push(e.data); };
      const done = new Promise(res=>{
        recorder.onstop = ()=>{
          stream.getTracks().forEach(t=>t.stop());
          res(new Blob(chunks, { type: mime }));
        };
      });

      const msg = (state.uppercase ? (state.message||'').toUpperCase() : (state.message||'\u00A0'));
      const fontPx = Math.round(W * (state.size/100));
      ctx.font = `${state.weight} ${fontPx}px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, sans-serif`;
      ctx.textBaseline = 'middle';

      const textW = ctx.measureText(msg).width;
      const gapPx = W * (state.gap/100);
      const span = Math.max(1, textW + gapPx);
      const pxPerSec = span / (state.speed || 12);
      const dirSign = (state.dir === 'rtl') ? 1 : -1;

      const bg = state.bg;
      const fg = state.fg;
      const glow = state.glow;
      const glowColor = state.glowColor;

      const t0 = performance.now();
      let rafId = 0;

      function drawFrame(now){
        const t = (now - t0) / 1000;
        const offset = ((dirSign * pxPerSec * t) % span + span) % span;

        ctx.save();
        ctx.fillStyle = bg; ctx.fillRect(0,0,W,H);

        if(glow){ ctx.shadowColor = glowColor; ctx.shadowBlur = Math.round(fontPx*0.25); }
        ctx.fillStyle = fg;

        const y = H/2;
        for(let x = -span; x < W + span; x += span){
          ctx.fillText(msg, x - offset, y);
        }
        ctx.restore();

        rafId = requestAnimationFrame(drawFrame);
      }

      await new Promise(r => requestAnimationFrame(r));
      recorder.start(250);
      rafId = requestAnimationFrame(drawFrame);
      await new Promise(res => setTimeout(res, sec*1000));
      cancelAnimationFrame(rafId);
      recorder.stop();

      const webmBlob = await done;
      return { blob: webmBlob, ext: 'webm', fps: FPS, res: state.res, sec };
    }

    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 3000);
    }

    // --- Loader robusto do FFmpeg UMD: local → jsDelivr → unpkg
    async function loadFFmpegUMD(){
      if (window.FFmpeg?.createFFmpeg) return window.FFmpeg;

      const urls = [
        '/ffmpeg/ffmpeg.min.js',
        'https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js',
        'https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js'
      ];

      for (const src of urls){
        try{
          await new Promise((resolve, reject)=>{
            const s = document.createElement('script');
            s.src = src;
            s.crossOrigin = 'anonymous';
            s.defer = true;
            s.onload = resolve;
            s.onerror = reject;
            document.head.appendChild(s);
          });
          if (window.FFmpeg?.createFFmpeg) return window.FFmpeg;
        }catch(_e){}
      }
      throw new Error('Não consegui carregar a biblioteca FFmpeg.');
    }

    // FFmpeg instância única com fallback no core
    let ffmpegInstance = null;
    async function ensureFFmpeg(){
      const FF = await loadFFmpegUMD();
      const { createFFmpeg } = FF;
      if (ffmpegInstance) return ffmpegInstance;

      const corePaths = [
        '/ffmpeg/ffmpeg-core.js',
        'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/ffmpeg-core.js',
        'https://unpkg.com/@ffmpeg/core@0.12.6/dist/ffmpeg-core.js'
      ];

      let lastErr = null;
      for (const corePath of corePaths){
        try{
          const inst = createFFmpeg({ log:false, corePath });
          await inst.load();
          ffmpegInstance = inst;
          return ffmpegInstance;
        }catch(e){ lastErr = e; }
      }
      throw lastErr || new Error('Falha ao carregar o core do FFmpeg.');
    }

    async function webmToMp4(webmBlob, outName, fps){
      const FF = await loadFFmpegUMD();
      const { fetchFile } = FF;
      const ffmpeg = await ensureFFmpeg();

      const inName = 'in.webm';
      const outFile = 'out.mp4';

      ffmpeg.FS('writeFile', inName, await fetchFile(webmBlob));

      await ffmpeg.run(
        '-i', inName,
        '-c:v', 'libx264',
        '-pix_fmt', 'yuv420p',
        '-movflags', '+faststart',
        '-r', String(fps),
        outFile
      );

      const data = ffmpeg.FS('readFile', outFile);
      const mp4Blob = new Blob([data.buffer], { type: 'video/mp4' });

      try { ffmpeg.FS('unlink', inName); } catch(_){}
      try { ffmpeg.FS('unlink', outFile); } catch(_){}

      downloadBlob(mp4Blob, outName);
    }

    renderWebmBtn.addEventListener('click', async ()=>{
      renderWebmBtn.disabled = true;
      const old = renderWebmBtn.textContent;
      renderWebmBtn.textContent = 'Gerando...';
      try{
        const { blob, fps, res, sec } = await renderAutoBlob();
        downloadBlob(blob, `letreiro_led_${res}_${fps}fps_${sec}s.webm`);
      }catch(err){
        alert(err?.message || String(err));
      }finally{
        renderWebmBtn.disabled = false;
        renderWebmBtn.textContent = old;
      }
    });

    renderMp4Btn.addEventListener('click', async ()=>{
      renderMp4Btn.disabled = true;
      const old = renderMp4Btn.textContent;
      renderMp4Btn.textContent = 'Convertendo...';
      try{
        const { blob, fps, res, sec } = await renderAutoBlob();
        await webmToMp4(blob, `letreiro_led_${res}_${fps}fps_${sec}s.mp4`, fps);
      }catch(err){
        alert(err?.message || String(err));
      }finally{
        renderMp4Btn.disabled = false;
        renderMp4Btn.textContent = old;
      }
    });

    document.addEventListener('visibilitychange', ()=>{
      if(!document.hidden && !state.paused){ track.style.animationPlayState = 'running'; }
    });
  </script>
</body>
</html>
